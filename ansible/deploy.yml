- hosts: web
  become: yes

  vars:
    dest: /srv/idontneedit/app
    ssh_port: 22

  vars_files:
    - secrets.yml

  tasks:

    - name: ensure deploy user exists
      ansible.builtin.user:
        name: deploy
        state: present
        shell: /bin/bash
        groups: www-data
        append: yes

    - name: set hostname
      ansible.builtin.hostname:
        name: idontneedit

    - name: update hosts file
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '127\.0\.1\.1\s+.*'
        line: "127.0.0.1 localhost idontneedit"

    - name: check core packages
      ansible.builtin.package:
        name:
          - unattended-upgrades
          - apt-transport-https
          - ca-certificates
          - curl
        state: present
        update_cache: yes

    - name: enable unattended-upgrades
      ansible.builtin.command: dpkg-reconfigure -f noninteractive unattended-upgrades

    - name: ensure ufw is installed
      ansible.builtin.package:
        name: ufw
        state: present
        update_cache: yes

    - name: reset ufw to default
      ansible.builtin.ufw:
        state: reset

    - name: allow ssh
      ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp

    - name: allow http
      ufw:
        rule: allow
        port: 80
        proto: tcp

    - name: allow https
      ufw:
        rule: allow
        port: 443
        proto: tcp

    - name: enable ufw
      ansible.builtin.ufw:
        state: enabled

    - name: disable password authentication for SSH
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PasswordAuthentication'
        line: 'PasswordAuthentication no'
        state: present

    - name: ensure SSH key auth only
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PubkeyAuthentication'
        line: 'PubkeyAuthentication yes'
        state: present

    - name: reload ssh
      ansible.builtin.service:
        name: ssh
        state: reloaded

    - name: install fail2ban
      ansible.builtin.package:
        name: fail2ban
        state: present
        update_cache: yes

    - name: ensure project dirs
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: deploy
        group: www-data
        mode: '0755'
      loop:
        - "{{ dest }}"
        - "{{ dest }}/ansible"

    - name: copy docker-compose.yml
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../docker-compose.yml"
        dest: "{{ dest }}/docker-compose.yml"
        owner: deploy
        group: www-data
        mode: '0644'

    - name: copy Caddyfile for proxy
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/Caddyfile"
        dest: "{{ dest }}/ansible/Caddyfile"
        owner: deploy
        group: www-data
        mode: '0644'

    - name: upload env file for Docker Compose
      ansible.builtin.template:
        src: env.j2
        dest: "{{ dest }}/.env"
        owner: deploy
        group: deploy
        mode: "0600"
      become: yes

    - name: ensure prerequisites for Docker repo
      ansible.builtin.package:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: ensure /etc/apt/keyrings exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: add Docker APT GPG key (Ubuntu)
      ansible.builtin.shell: "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg"
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: add Docker APT repository (Ubuntu)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        filename: docker
        state: present

    - name: install Docker engine and plugins from Docker repo
      ansible.builtin.package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: add deploy user to docker group
      ansible.builtin.user:
        name: deploy
        groups: docker
        append: yes

    - name: start and enable docker service
      ansible.builtin.systemd:
        name: docker
        enabled: yes
        state: started

    - name: pull latest images via Docker Compose
      ansible.builtin.command: docker compose pull
      args:
        chdir: "{{ dest }}"
      become_user: deploy

    - name: bring up stack via Docker Compose (force recreate)
      ansible.builtin.command: docker compose up -d --force-recreate
      args:
        chdir: "{{ dest }}"
      become_user: deploy

    - name: run database migrations
      ansible.builtin.command: docker compose exec -T app python manage.py migrate --noinput
      args:
        chdir: "{{ dest }}"
      become_user: deploy

    - name: collect static files into shared volume
      ansible.builtin.command: docker compose exec -T app python manage.py collectstatic --noinput
      args:
        chdir: "{{ dest }}"
      become_user: deploy
